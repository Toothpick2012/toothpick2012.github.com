<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>block在arc与非arc区别 &#8211; 牙=_签's Blog</title>
<meta name="description" content="">
<meta name="keywords" content="block, arc, 笔录, 区别">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="block在arc与非arc区别">
<meta property="og:description" content="">
<meta property="og:url" content="http://blog.qiumingxing.cn/ios/block%E5%9C%A8arc%E4%B8%8E%E9%9D%9Earc%E5%8C%BA%E5%88%AB/">
<meta property="og:site_name" content="牙=_签's Blog">





<link rel="canonical" href="http://blog.qiumingxing.cn/ios/block%E5%9C%A8arc%E4%B8%8E%E9%9D%9Earc%E5%8C%BA%E5%88%AB/">
<link href="http://blog.qiumingxing.cn/feed.xml" type="application/atom+xml" rel="alternate" title="牙=_签's Blog Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://blog.qiumingxing.cn/assets/css/main.min.css">
<link rel="stylesheet" href="http://blog.qiumingxing.cn/custom/css/main.css">
<!-- Webfonts -->
<!-- <link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css"> -->

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://blog.qiumingxing.cn/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://blog.qiumingxing.cn/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://blog.qiumingxing.cn/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://blog.qiumingxing.cn/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://blog.qiumingxing.cn/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://blog.qiumingxing.cn/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://blog.qiumingxing.cn/images/apple-touch-icon-144x144-precomposed.png">



<script src="http://blog.qiumingxing.cn/custom/js/sea.js"></script>
<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script src="http://blog.qiumingxing.cn/custom/js/gallery.js"></script>

</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">菜单</button>
	<ul class="dl-menu">
		<li><a href="http://blog.qiumingxing.cn/">首页</a></li>
		<li>
			<a href="#">文章</a>
			<ul class="dl-submenu">
				<li><a href="http://blog.qiumingxing.cn/posts/">所有文章</a></li>
				<li><a href="http://blog.qiumingxing.cn/tags/">所有标签</a></li>
			</ul>
		</li>
		<li><a href="http://blog.qiumingxing.cn/search.html">搜索</a></li>
		<li>
			<a href="#">关于</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://blog.qiumingxing.cn/images/avatar.jpg" alt="toothpickv photo" class="author-photo">
					<h4>toothpickv</h4>
					<p>一个中国汉纸</p>
				</li>
				<li><a href="http://blog.qiumingxing.cn/about/">更多</a></li>
				<li>
					<a href="mailto:toothpick.v@gmail.com"><i class="icon-envelope"></i> Email</a>
				</li>
				
				
				
				
				
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<!-- <li><a href="http://blog.qiumingxing.cn/theme-setup">Theme Setup</a></li><li><a href="http://mademistakes.com">External Link</a></li> -->
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->



<div class="entry-header">
  
  <div class="entry-image">
    

  	  
		      
  			<div class="entry-image" style="background: #000000">
		 
  		
  			</div>
    
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="http://blog.qiumingxing.cn/ios/block%E5%9C%A8arc%E4%B8%8E%E9%9D%9Earc%E5%8C%BA%E5%88%AB/" rel="bookmark" title="block在arc与非arc区别">block在arc与非arc区别</a></h1>
        
        <h2>10月31, 2014 <!-- October 31, 2014 --></h2>
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <h1>block在arc与非arc区别</h1>

<p>来自：http://www.cnbluebox.com/?p=255</p>

<h2>Block简介</h2>

<p>Block作为C语言的扩展，并不是高新技术，和其他语言的闭包或lambda表达式是一回事。需要注意的是由于Objective-C在iOS中不支持GC机制，使用Block必须自己管理内存，而内存管理正是使用Block坑最多的地方，错误的内存管理 要么导致return cycle内存泄漏要么内存被提前释放导致crash。 Block的使用很像函数指针，不过与函数最大的不同是：Block可以访问函数以外、词法作用域以内的外部变量的值。换句话说，Block不仅 实现函数的功能，还能携带函数的执行环境。</p>

<p>可以这样理解，Block其实包含两个部分内容</p>

<blockquote>
<ul>
<li>Block执行的代码，这是在编译的时候已经生成好的；</li>
<li>一个包含Block执行时需要的所有外部变量值的数据结构。 Block将使用到的、作用域附近到的变量的值建立一份快照拷贝到栈上。</li>
</ul>
</blockquote>

<p>Block与函数另一个不同是，Block类似ObjC的对象，可以使用自动释放池管理内存（但Block并不完全等同于ObjC对象，后面将详细说明）。</p>

<h2>Block的类型与内存管理</h2>

<p>根据Block在内存中的位置分为三种类型NSGlobalBlock，NSStackBlock, NSMallocBlock。</p>

<p>NSGlobalBlock：类似函数，位于text段；
NSStackBlock：位于栈内存，函数返回后Block将无效；
NSMallocBlock：位于堆内存。
1、NSGlobalBlock如下，我们可以通过是否引用外部变量识别，未引用外部变量即为NSGlobalBlock，可以当做函数使用。</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="p">{</span>
    <span class="c1">//create a NSGlobalBlock</span>
    <span class="kt">float</span> <span class="p">(</span><span class="o">^</span><span class="n">sum</span><span class="p">)(</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="kt">float</span> <span class="n">a</span><span class="p">,</span> <span class="kt">float</span> <span class="n">b</span><span class="p">){</span>

        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;block is %@&quot;</span><span class="p">,</span> <span class="n">sum</span><span class="p">);</span> <span class="c1">//block is &lt;__NSGlobalBlock__: 0x47d0&gt;</span>
<span class="p">}</span>
</code></pre></div>
<p>2、NSStackBlock如下：</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="p">{</span>
    <span class="bp">NSArray</span> <span class="o">*</span><span class="n">testArr</span> <span class="o">=</span> <span class="l">@[</span><span class="s">@&quot;1&quot;</span><span class="p">,</span> <span class="s">@&quot;2&quot;</span><span class="l">]</span><span class="p">;</span>

    <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">TestBlock</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>

        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;testArr :%@&quot;</span><span class="p">,</span> <span class="n">testArr</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;block is %@&quot;</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>

        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;test Arr :%@&quot;</span><span class="p">,</span> <span class="n">testArr</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="c1">//block is &lt;__NSStackBlock__: 0xbfffdac0&gt;</span>
    <span class="c1">//打印可看出block是一个 NSStackBlock, 即在栈上, 当函数返回时block将无效</span>

    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;block is %@&quot;</span><span class="p">,</span> <span class="n">TestBlock</span><span class="p">);</span>
    <span class="c1">//block is &lt;__NSMallocBlock__: 0x75425a0&gt;</span>
    <span class="c1">//上面这句在非arc中打印是 NSStackBlock, 但是在arc中就是NSMallocBlock</span>
    <span class="c1">//即在arc中默认会将block从栈复制到堆上，而在非arc中，则需要手动copy.</span>
<span class="p">}</span>
</code></pre></div>
<p>3、NSMallocBlock只需要对NSStackBlock进行copy操作就可以获取，但是retain操作就不行,会在下面说明</p>

<h2>Block的copy、retain、release操作</h2>

<p>不同于NSObjec的copy、retain、release操作：</p>

<ul>
<li>Block<em>copy与copy等效，Block</em>release与release等效；</li>
<li>对Block不管是retain、copy、release都不会改变引用计数retainCount，retainCount始终是1；</li>
<li>NSGlobalBlock：retain、copy、release操作都无效；</li>
<li>NSStackBlock：retain、release操作无效，必须注意的是，NSStackBlock在函数返回后，Block内存将被回收。即使retain也没用。容易犯的错误是[[mutableAarry addObject:stackBlock]，（补：在arc中不用担心此问题，因为arc中会默认将实例化的block拷贝到堆上）在函数出栈后，从mutableAarry中取到的stackBlock已经被回收，变成了野指针。正确的做法是先将stackBlock copy到堆上，然后加入数组：[mutableAarry addObject:[[stackBlock copy] autorelease]]。支持copy，copy之后生成新的NSMallocBlock类型对象。</li>
<li>NSMallocBlock支持retain、release，虽然retainCount始终是1，但内存管理器中仍然会增加、减少计数。copy之后不会生成新的对象，只是增加了一次引用，类似retain；
尽量不要对Block使用retain操作。</li>
</ul>

<h2>Block对外部变量的存取管理</h2>

<h3>基本数据类型</h3>

<p>1、局部变量
局部自动变量，在Block中只读。Block定义时copy变量的值，在Block中作为常量使用，所以即使变量的值在Block外改变，也不影响他在Block中的值。</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="p">{</span>
    <span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="kt">long</span> <span class="p">(</span><span class="o">^</span><span class="n">sum</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span> <span class="kt">long</span> <span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
    <span class="c1">// 这里输出是103，而不是3, 因为块内base为拷贝的常量 100</span>
<span class="p">}</span>
</code></pre></div>
<p>2、STATIC修饰符的全局变量
因为全局变量或静态变量在内存中的地址是固定的，Block在读取该变量值的时候是直接从其所在内存读出，获取到的是最新值，而不是在定义时copy的常量.</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="kt">long</span> <span class="p">(</span><span class="o">^</span><span class="n">sum</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span> <span class="kt">long</span> <span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">base</span><span class="o">++</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
    <span class="c1">// 这里输出是4，而不是103, 因为base被设置为了0</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
    <span class="c1">// 这里输出1， 因为sum中将base++了</span>
<span class="p">}</span>
</code></pre></div>
<p>3、<strong>BLOCK修饰的变量
Block变量，被</strong>block修饰的变量称作Block变量。 基本类型的Block变量等效于全局变量、或静态变量。</p>

<ul>
<li><code>注</code>：BLOCK被另一个BLOCK使用时，另一个BLOCK被COPY到堆上时，被使用的BLOCK也会被COPY。但作为参数的BLOCK是不会发生COPY的</li>
</ul>

<h3>OBJC对象</h3>

<p>block对于objc对象的内存管理较为复杂，这里要分static global local block变量分析、还要分非arc和arc分析</p>

<h4>非ARC中的变量</h4>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="k">@interface</span> <span class="nc">MyClass</span> : <span class="bp">NSObject</span> <span class="p">{</span>
    <span class="bp">NSObject</span><span class="o">*</span> <span class="n">_instanceObj</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">MyClass</span>

<span class="bp">NSObject</span><span class="o">*</span> <span class="n">__globalObj</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span> <span class="nf">init</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">_instanceObj</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSObject</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">test</span> <span class="p">{</span>
    <span class="k">static</span> <span class="bp">NSObject</span><span class="o">*</span> <span class="n">__staticObj</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">__globalObj</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSObject</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
    <span class="n">__staticObj</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSObject</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>

    <span class="bp">NSObject</span><span class="o">*</span> <span class="n">localObj</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSObject</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
    <span class="k">__block</span> <span class="bp">NSObject</span><span class="o">*</span> <span class="n">blockObj</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSObject</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>

    <span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">MyBlock</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="p">;</span>
    <span class="n">MyBlock</span> <span class="n">aBlock</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">__globalObj</span><span class="p">);</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">__staticObj</span><span class="p">);</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">_instanceObj</span><span class="p">);</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">localObj</span><span class="p">);</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">blockObj</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="n">aBlock</span> <span class="o">=</span> <span class="p">[[</span><span class="n">aBlock</span> <span class="k">copy</span><span class="p">]</span> <span class="n">autorelease</span><span class="p">];</span>
    <span class="n">aBlock</span><span class="p">();</span>

    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">__globalObj</span> <span class="n">retainCount</span><span class="p">]);</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">__staticObj</span> <span class="n">retainCount</span><span class="p">]);</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">_instanceObj</span> <span class="n">retainCount</span><span class="p">]);</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">localObj</span> <span class="n">retainCount</span><span class="p">]);</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">blockObj</span> <span class="n">retainCount</span><span class="p">]);</span>
<span class="p">}</span>
<span class="k">@end</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">@autoreleasepool</span> <span class="p">{</span>
        <span class="n">MyClass</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">MyClass</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">]</span> <span class="n">autorelease</span><span class="p">];</span>
        <span class="p">[</span><span class="n">obj</span> <span class="n">test</span><span class="p">];</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>执行结果为1 1 1 2 1。</p>

<ul>
<li><p><code>__globalObj</code>和<code>__staticObj</code>在内存中的位置是确定的，所以Block copy时不会retain对象。</p></li>
<li><p><code>_instanceObj</code>在Block copy时也没有直接retain <code>_instanceObj</code>对象本身，但会retain self。所以在Block中可以直接读写<code>_instanceObj</code>变量。</p></li>
<li><p>localObj在Block copy时，系统自动retain对象，增加其引用计数。</p></li>
<li><p>blockObj在Block copy时也不会retain。</p></li>
</ul>

<h4>ARC中的变量测试</h4>

<p>由于arc中没有retain，retainCount的概念。只有强引用和弱引用的概念。当一个变量没有__strong的指针指向它时，就会被系统释放。因此我们可以通过下面的代码来测试。</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="bp">NSString</span> <span class="o">*</span><span class="n">__globalString</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">testGlobalObj</span>
<span class="p">{</span>
    <span class="n">__globalString</span> <span class="o">=</span> <span class="s">@&quot;1&quot;</span><span class="p">;</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">TestBlock</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>

        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;string is :%@&quot;</span><span class="p">,</span> <span class="n">__globalString</span><span class="p">);</span> <span class="c1">//string is :(null)</span>
    <span class="p">};</span>

    <span class="n">__globalString</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>

    <span class="n">TestBlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">testStaticObj</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">__staticString</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">__staticString</span> <span class="o">=</span> <span class="s">@&quot;1&quot;</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;static address: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__staticString</span><span class="p">);</span>    <span class="c1">//static address: 0x6a8c</span>

    <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">TestBlock</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;static address: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__staticString</span><span class="p">);</span> <span class="c1">//static address: 0x6a8c</span>

        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;string is : %@&quot;</span><span class="p">,</span> <span class="n">__staticString</span><span class="p">);</span> <span class="c1">//string is :(null)</span>
    <span class="p">};</span>

    <span class="n">__staticString</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>

    <span class="n">TestBlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">testLocalObj</span>
<span class="p">{</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">__localString</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">__localString</span> <span class="o">=</span> <span class="s">@&quot;1&quot;</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;local address: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__localString</span><span class="p">);</span> <span class="c1">//local address: 0xbfffd9c0</span>

    <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">TestBlock</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;local address: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__localString</span><span class="p">);</span> <span class="c1">//local address: 0x71723e4</span>

        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;string is : %@&quot;</span><span class="p">,</span> <span class="n">__localString</span><span class="p">);</span> <span class="c1">//string is : 1</span>
    <span class="p">};</span>

    <span class="n">__localString</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>

    <span class="n">TestBlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">testBlockObj</span>
<span class="p">{</span>
    <span class="k">__block</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">_blockString</span> <span class="o">=</span> <span class="s">@&quot;1&quot;</span><span class="p">;</span>

    <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">TestBlock</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>

        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;string is : %@&quot;</span><span class="p">,</span> <span class="n">_blockString</span><span class="p">);</span> <span class="c1">// string is :(null)</span>
    <span class="p">};</span>

    <span class="n">_blockString</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>

    <span class="n">TestBlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">testWeakObj</span>
<span class="p">{</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">__localString</span> <span class="o">=</span> <span class="s">@&quot;1&quot;</span><span class="p">;</span>

    <span class="k">__weak</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">weakString</span> <span class="o">=</span> <span class="n">__localString</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;weak address: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">weakString</span><span class="p">);</span>  <span class="c1">//weak address: 0xbfffd9c4</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;weak str address: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">weakString</span><span class="p">);</span> <span class="c1">//weak str address: 0x684c</span>

    <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">TestBlock</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;weak address: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">weakString</span><span class="p">);</span> <span class="c1">//weak address: 0x7144324</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;weak str address: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">weakString</span><span class="p">);</span> <span class="c1">//weak str address: 0x684c</span>

        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;string is : %@&quot;</span><span class="p">,</span> <span class="n">weakString</span><span class="p">);</span> <span class="c1">//string is :1</span>
    <span class="p">};</span>

    <span class="n">__localString</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>

    <span class="n">TestBlock</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>由以上几个测试我们可以得出：</p>

<ul>
<li><p>1、只有在使用local变量时，block会复制指针，且强引用指针指向的对象一次。其它如全局变量、static变量、block变量等，block不会拷贝指针,只会强引用指针指向的对象一次。</p></li>
<li><p>2、即时标记了为<strong>weak或</strong>unsafe_unretained的local变量。block仍会强引用指针对象一次。（这个不太明白，因为这种写法可在后面避免循环引用的问题）</p></li>
</ul>

<h2>循环引用retain cycle</h2>

<p>循环引用指两个对象相互强引用了对方，即retain了对方，从而导致谁也释放不了谁的内存泄露问题。如声明一个delegate时一般用assign而不能用retain或strong，因为你一旦那么做了，很大可能引起循环引用。在以往的项目中，我几次用动态内存检查发现了循环引用导致的内存泄露。</p>

<p>这里讲的是block的循环引用问题，因为block在拷贝到堆上的时候，会retain其引用的外部变量，那么如果block中如果引用了他的宿主对象，那很有可能引起循环引用，如：</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="nb">self</span><span class="p">.</span><span class="n">myblock</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>

            <span class="p">[</span><span class="nb">self</span> <span class="n">doSomething</span><span class="p">];</span>
        <span class="p">};</span>
</code></pre></div>
<p>为测试循环引用，写了些测试代码用于避免循环引用的方法，如下，（只有arc的，懒得做非arc测试了）</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">dealloc</span>
<span class="p">{</span>

    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;no cycle retain&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">init</span>
<span class="p">{</span>
    <span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">{</span>

<span class="cp">#if TestCycleRetainCase1</span>

        <span class="c1">//会循环引用</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">myblock</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>

            <span class="p">[</span><span class="nb">self</span> <span class="n">doSomething</span><span class="p">];</span>
        <span class="p">};</span>
<span class="cp">#elif TestCycleRetainCase2</span>

        <span class="c1">//会循环引用</span>
        <span class="k">__block</span> <span class="n">TestCycleRetain</span> <span class="o">*</span><span class="n">weakSelf</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">myblock</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>

            <span class="p">[</span><span class="n">weakSelf</span> <span class="n">doSomething</span><span class="p">];</span>
        <span class="p">};</span>

<span class="cp">#elif TestCycleRetainCase3</span>

        <span class="c1">//不会循环引用</span>
        <span class="k">__weak</span> <span class="n">TestCycleRetain</span> <span class="o">*</span><span class="n">weakSelf</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">myblock</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>

            <span class="p">[</span><span class="n">weakSelf</span> <span class="n">doSomething</span><span class="p">];</span>
        <span class="p">};</span>

<span class="cp">#elif TestCycleRetainCase4</span>

        <span class="c1">//不会循环引用</span>
        <span class="n">__unsafe_unretained</span> <span class="n">TestCycleRetain</span> <span class="o">*</span><span class="n">weakSelf</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">myblock</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>

            <span class="p">[</span><span class="n">weakSelf</span> <span class="n">doSomething</span><span class="p">];</span>
        <span class="p">};</span>

<span class="cp">#endif</span>

        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;myblock is %@&quot;</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="n">myblock</span><span class="p">);</span>

    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">doSomething</span>
<span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;do Something&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">@autoreleasepool</span> <span class="p">{</span>
        <span class="n">TestCycleRetain</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">[[</span><span class="n">TestCycleRetain</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>经过上面的测试发现，在加了<code>__weak</code>和<code>__unsafe_unretained</code>的变量引入后，TestCycleRetain方法可以正常执行dealloc方法，而不转换和用<code>__block</code>转换的变量都会引起循环引用。
因此防止循环引用的方法如下：</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="n">__unsafe_unretained</span> <span class="n">TestCycleRetain</span> <span class="o">*</span><span class="n">weakSelf</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
</code></pre></div>
      <footer class="entry-meta">
        <span class="entry-tags"><a href="http://blog.qiumingxing.cn/tags/#block" title="Pages tagged block" class="tag">block</a><a href="http://blog.qiumingxing.cn/tags/#arc" title="Pages tagged arc" class="tag">arc</a><a href="http://blog.qiumingxing.cn/tags/#笔录" title="Pages tagged 笔录" class="tag">笔录</a><a href="http://blog.qiumingxing.cn/tags/#区别" title="Pages tagged 区别" class="tag">区别</a></span>
        <span><a href="http://blog.qiumingxing.cn/ios/block%E5%9C%A8arc%E4%B8%8E%E9%9D%9Earc%E5%8C%BA%E5%88%AB/" rel="bookmark" title="block在arc与非arc区别">block在arc与非arc区别</a> was published on <span class="entry-date date published updated"><time datetime="2014-10-31T15:56:55-04:00">October 31, 2014</time></span></span>
        
        <span class="author vcard"><span class="fn"><a href="http://blog.qiumingxing.cn/about/" title="About toothpickv">toothpickv</a></span></span>
        
      </footer>
    </div><!-- /.entry-content -->
    
    <!--多说js加载开始，一个页面只需要加载一次 -->
<script type="text/javascript">
	var duoshuoQuery = {short_name:"toothpickv"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>
<!--多说js加载结束，一个页面只需要加载一次 -->
<!-- Duoshuo Comment BEGIN -->
	<div id="comments">
		<div class="ds-thread" data-title="block在arc与非arc区别 - 牙=_签's Blog"></div>
	</div>
<!-- Duoshuo Comment END -->
    
    <div class="read-more">
      
        <div class="read-more-header">
          <a href="http://blog.qiumingxing.cn/ios/iOS%E5%BC%80%E5%8F%91%E4%BB%A3%E7%A0%81%E7%AD%BE%E5%90%8D%E7%AC%94%E5%BD%95/" class="read-more-btn">Read More</a>
        </div><!-- /.read-more-header -->
        <div class="read-more-content">
          <h3><a href="http://blog.qiumingxing.cn/ios/iOS%E5%BC%80%E5%8F%91%E4%BB%A3%E7%A0%81%E7%AD%BE%E5%90%8D%E7%AC%94%E5%BD%95/" title="iOS开发代码签名笔录">iOS开发代码签名笔录</a></h3>
          <p> <a href="http://blog.qiumingxing.cn/ios/iOS%E5%BC%80%E5%8F%91%E4%BB%A3%E7%A0%81%E7%AD%BE%E5%90%8D%E7%AC%94%E5%BD%95/">Continue reading</a></p>
        </div><!-- /.read-more-content -->
      
      <div class="read-more-list">
        
          <div class="list-item">
            <h4><a href="http://blog.qiumingxing.cn/ios/CocoaPods%E7%AE%A1%E7%90%86%E4%B8%AA%E4%BA%BA%E6%9C%AC%E5%9C%B0%E5%BA%93/" title="CocoaPods管理个人本地库">CocoaPods管理个人本地库</a></h4>
            <span>Published on October 29, 2014</span>
          </div><!-- /.list-item -->
        
          <div class="list-item">
            <h4><a href="http://blog.qiumingxing.cn/ios/CocoaPods%E5%B0%8F%E6%8A%80%E5%B7%A7/" title="CocoaPods小技巧">CocoaPods小技巧</a></h4>
            <span>Published on October 28, 2014</span>
          </div><!-- /.list-item -->
        
      </div><!-- /.read-more-list -->
      
    </div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2014 toothpickv.</span>

<!-- Baidu Analytics snippet -->
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fccf659d598605041092bdb6fcfda452b' type='text/javascript'%3E%3C/script%3E"));
</script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49476672-1', 'qiumingxing.cn');
  ga('send', 'pageview');

</script>

<!-- 百度分享 -->
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"0","bdPos":"left","bdTop":"250"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="http://blog.qiumingxing.cn/assets/js/scripts.min.js"></script>

	        

</body>
</html>
